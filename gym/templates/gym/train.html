{% extends "gym/base.html" %}

{% block content %}
<style>
    #app {
        font-size: 180%;
    }

    #answer {
        font-size: 100%;
        display: none;
    }

    #answer.show {
        display: inline;
    }
</style>

<script>
    const toggle = () => {
        const answer = document.getElementById('answer');
        answer.classList.toggle('show');
    }

    const hide = () => {
        const answer = document.getElementById('answer');
        answer.classList.remove('show');
    }

    const getCookie = (name) => {
        if (document.cookie && document.cookie !== '') {
            for (const cookie of document.cookie.split(';')) {
                const [key, value] = cookie.trim().split('=')
                if (key === name) {
                    return decodeURIComponent(value)
                }
            }
        }
    }

    const getCsrftoken = async (url) => {
        let csrftoken = getCookie("csrftoken")
        if (csrftoken == undefined) {
            await fetch(url)
            csrftoken = getCookie("csrftoken");
        }
        return csrftoken
    }

    const logging = async (result) => {
        const endpoint = "{% url 'api_logging' %}";
        const url = `${location.protocol}//${location.host}${endpoint}`;
        const query = `${url}?phrase_group_id=${id}&result=${result}`;
        const csrftoken = await getCsrftoken(url);

        fetch(query, {
            method: "POST",
            headers: {
                "X-CSRFToken": csrftoken
            }
        })
            .then(data => {
                if (data.status == 201) {
                    hide();
                    getSentence();
                };
            });
    };

    const getSentence = () => {
        const xhr = new XMLHttpRequest();
        const endpoint = "{% url 'api_sentence' %}";
        const url = `${location.protocol}//${location.host}${endpoint}`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                window.document.getElementById("tense").innerHTML = data.tense;
                window.document.getElementById("subject").innerHTML = data.subject;
                window.document.getElementById("sentence_type").innerHTML = data.sentence_type;
                window.document.getElementById("phrase").innerHTML = data.phrase;
                window.document.getElementById("sentence").innerHTML = data.sentence;
                window.document.getElementById("base_ja").innerHTML = data.base_ja;
                id = data.id
            });
    };

    let id;
    getSentence();

</script>

<div id="app">
    <p>時制: <span id="tense"></span></p>
    <p>主語: <span id="subject"></span></p>
    <p>種類: <span id="sentence_type"></span></p>
    <p>フレーズ: <span id="phrase"></span></p>
    <hr>
    <div id="answer">
        <p><span id="sentence"></span></p>
        <p><span id="base_ja"></span></p>
    </div>
    <div class="buttons">
        <button onclick="toggle()">show</button><br>
        <button onclick="logging('succeed')">○</button>
        <button onclick="logging('failed')">×</button>
    </div>
</div>
{% endblock %}